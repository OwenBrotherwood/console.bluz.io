<html>
<head>
    <link rel="shortcut icon" href="img/bluz_only_logo.png">
    <title>bluz console</title>

    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/spark-browser-style.css" type="text/css">
    <link href="css/toastr.css" rel="stylesheet"/>

    <script src="js/jquery.js"></script>
    <script type="text/javascript" src="js/particle.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/toastr.min.js"></script>
</head>

<body>
<div class="waitScreen"></div>

<script>

    var accessToken, myDevices;
    var particle = new Particle();

    var waiting = function(waiting) {
        if (waiting) {
            $("body").addClass("loading");
        } else {
            $("body").removeClass("loading");
        }
    }

    var isGatewayClaimed = function(deviceID) {
        var found = false;
        myDevices.forEach(function(device) {
            if (device.id===deviceID) {
                found = true;
            }
        });
        return found;
    }

    var claimDevice = function(button, deviceID) {
        particle.claimDevice({ deviceId: deviceID, auth: accessToken }).then(function(data) {
            console.log('device claim data:', data);
            toastr.info('Successfully claimed device');
            $(button).hide();
        }, function(err) {
            console.log('device claim err:', err);
            toastr.error('Unable to claim device: ' + err.errorDescription);
        });
    }

    var parseDeviceAttributesForGateways = function(device, data) {
        if (data.body.variables != null && data.body.variables.hasOwnProperty('gatewayID')) {
            particle.getVariable({ deviceId: device.id, name: 'gatewayID', auth: accessToken }).then(function(data) {
                console.log('Device variable retrieved successfully:', data);
                var deviceID = data.body.result.substring(0, 24);
                if (!isGatewayClaimed(deviceID)) {
                    $('#gateway-list tr:last').after('<tr><td align="center"><img src="img/gw_combined.png" class="img-responsive" width="300"/><p>' + deviceID + '</p><button class="claim-button" onclick="claimDevice(this, \'' + deviceID + '\')">Claim</button></td></tr>');
                } else {
                    $('#gateway-list tr:last').after('<tr><td align="center"><img src="img/gw_combined.png" class="img-responsive" width="300"/><p>' + deviceID + '</p></td></tr>');
                }

            }, function(err) {
                console.log('An error occurred while getting attrs:', err);
            });
        }
    }

    var parseDevicesForGateways = function(devices) {
        var deviceCounter = 0;
        devices.body.forEach(function(device) {
            var devicesPr = particle.getDevice({ deviceId: device.id, auth: accessToken });

            devicesPr.then(
                    function(data){
                        console.log('Device attrs retrieved successfully:', data);
                        parseDeviceAttributesForGateways(device, data);
                        deviceCounter++;
                        if (deviceCounter == devices.body.length) { waiting(false); }
                    },
                    function(err) {
                        console.log('API call failed: ', err);
                        deviceCounter++;
                        if (deviceCounter == devices.body.length) { waiting(false); }
                    }
            );
        });
    }

    var listDevices = function() {
        var devicesPr = particle.listDevices({ auth: accessToken });

        devicesPr.then(
            function(devices){
                console.log('Devices: ', devices);
                myDevices = devices.body;
                parseDevicesForGateways(devices);
            },
            function(err) {
                console.log('List devices call failed: ', err);
            }
        );
    }

    var loginClicked = function() {
        $('#spark-login-form-error').hide();

        var user = $('#spark-login-form-email').val();
        var pass = $('#spark-login-form-password').val();

        particle.login({username: user, password:  pass}).then(
            function(data){
                console.log('API call completed on promise resolve: ', data.body.access_token);
                accessToken = data.body.access_token;
                $('.spark-login-modal').hide();
                waiting(true);
                listDevices();
            },
            function(err) {
                $('#spark-login-form-error').show();
                console.log('API call completed on promise fail: ', err);
            }
        );

    }

</script>

<div class="container">
    <div class="page-inner">
        <div class="row">
            <div class="col-lg-4"></div>
            <div class="col-lg-4">
                <h2 class="center-text">Welcome to the bluz console</h2>
                <form class="spark-login-modal">
                    <div id="spark-login-form-error" class="spark-login-error">
                        <p>Error logging in</p>
                    </div>
                    <input id="spark-login-form-email" class="spark-login-input" type="email" placeholder="email">
                    <input id="spark-login-form-password" class="spark-login-input" type="password" placeholder="password">
                    <button id="spark-login-form-button" class="spark-login-button" onclick="loginClicked()" type='button'>Login to Particle</button>
                </form>

                <div class="center-text">
                    <table id="gateway-list" align="center">
                        <tbody><tr></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
